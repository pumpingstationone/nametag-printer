---
- hosts: localhost
  gather_facts: false
  tasks:
    - name: Build Docker image locally
      community.docker.docker_image:
        name: nametags
        tag: latest
        build:
          path: "{{ playbook_dir }}/../"
          platform: "linux/arm64"
        source: build
      register: build_result

    - name: Ensure dist directory exists
      ansible.builtin.file:
        path: "{{ playbook_dir }}/../dist"
        state: directory
        mode: '0755'

    - name: Save Docker image to tarball
      community.docker.docker_image:
        name: nametags:latest
        load_path: null
        repository: nametags
        tag: latest
        push: false
        source: local
        archive_path: "{{ playbook_dir }}/../dist/nametags.tar"
        state: present
      when: build_result is changed or build_result is succeeded

- hosts: nametags
  become: true
  tasks:
    - name: Check if docker installed
      shell: dpkg-query -W 'docker-ce'
      ignore_errors: True
      register: installed_docker

    - name: Download Docker GPG key
      ansible.builtin.get_url:
        url: https://download.docker.com/linux/ubuntu/gpg
        dest: /usr/share/keyrings/docker-archive-keyring.gpg
        mode: '0644'

    - name: Add Docker apt repository
      ansible.builtin.apt_repository:
        repo: "deb [arch=arm64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu bionic stable"
        state: present
      when: installed_docker is failed

    - name: Install docker package
      apt:
        name:
        - docker-ce
        # - python3-pip
        update_cache: yes
        force_apt_get: yes
      when: installed_docker is failed

    - name: Copy Docker image tarball to Pi
      copy:
        src: "{{ playbook_dir }}/../dist/nametags.tar"
        dest: /tmp/nametags.tar
        mode: '0644'

    - name: Load Docker image on Pi
      community.docker.docker_image:
        name: nametags:latest
        load_path: /tmp/nametags.tar
        source: load

    - name: Run nametags container
      community.docker.docker_container:
        name: nametags
        image: nametags:latest
        state: started
        restart_policy: unless-stopped
        published_ports:
          - 5000:5000
        env:
          TZ: America/Chicago
