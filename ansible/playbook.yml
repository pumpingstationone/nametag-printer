- hosts: nametags
  become: true
  tasks:
    - name: Install system dependencies
      apt:
        name:
          - libusb-1.0-0-dev
          - kbd
          - imagemagick
          - supervisor
        update_cache: yes

    - name: Install uv (official static binary for ARM64)
      get_url:
        url: https://github.com/astral-sh/uv/releases/download/0.7.15/uv-aarch64-unknown-linux-gnu.tar.gz
        dest: /tmp/uv.tar.gz
        mode: '0755'

    - name: Extract uv binary
      unarchive:
        src: /tmp/uv.tar.gz
        dest: /usr/local/bin/
        remote_src: yes
      args:
        creates: /usr/local/bin/uv

    - name: Rename uv binary
      command: mv /usr/local/bin/uv-aarch64-unknown-linux-gnu/uv /usr/local/bin/uv
      args:
        removes: /usr/local/bin/uv-aarch64-unknown-linux-gnu/uv
        creates: /usr/local/bin/uv

    - name: Remove extracted uv directory
      command: rm -r /usr/local/bin/uv-aarch64-unknown-linux-gnu
      args:
        removes: /usr/local/bin/uv-aarch64-unknown-linux-gnu/uv

    - name: Ensure uv binary is executable
      file:
        path: /usr/local/bin/uv
        mode: '0755'

    - name: Ensure app directory exists
      file:
        path: /app
        state: directory
        mode: '0755'

    - name: Copy app source code
      ansible.builtin.synchronize:
        src: ../src/
        dest: /app/src/
        delete: yes
        rsync_opts:
          - "--checksum"
          - "--exclude=__pycache__"
          - "--exclude=*.pyc"
          - "--exclude=*.pyo"

    - name: Copy pyproject.toml and uv.lock
      copy:
        src: "{{ item }}"
        dest: /app/
        mode: '0644'
      loop:
        - ../pyproject.toml
        - ../uv.lock

    - name: Check if .env exists and has required variables with non-empty values
      shell: |
        test -f "{{ playbook_dir }}/../.env" \
        && grep -qE '^WA_CLIENT_ID=.+' "{{ playbook_dir }}/../.env" \
        && grep -qE '^WA_CLIENT_SECRET=.+' "{{ playbook_dir }}/../.env" \
        && grep -qE '^WA_API_KEY=.+' "{{ playbook_dir }}/../.env"
      register: env_check
      ignore_errors: true
      changed_when: false
      delegate_to: localhost

    - name: Copy .env to /app/.env if valid
      copy:
        src: "{{ playbook_dir }}/../.env"
        dest: /app/.env
        mode: '0600'
      when: env_check.rc == 0

    - name: Install Python dependencies with uv
      shell: |
        cd /app && uv sync --no-dev
      args:
        creates: /app/.venv

    - name: Copy supervisord.conf
      copy:
        src: ../supervisord.conf
        dest: /etc/supervisor/conf.d/supervisord.conf
        mode: '0644'

    - name: Ensure supervisor is started
      service:
        name: supervisor
        state: started
        enabled: yes

    - name: Restart supervisor to reload config
      service:
        name: supervisor
        state: restarted
